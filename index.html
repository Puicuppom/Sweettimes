<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Times üíñ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Itim', cursive; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-rose-50">

    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold text-rose-500 mb-2">Sweet Times</h1>
            <p class="text-gray-500 mb-6">üíñ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏ß‡∏µ‡∏ó‡∏Ç‡∏≠‡∏á‡∏™‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üíñ</p>
            <form id="login-form">
                <div class="mb-4 text-left">
                    <label class="block text-gray-700 mb-1" for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input id="email" type="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                </div>
                <div class="mb-6 text-left">
                    <label class="block text-gray-700 mb-1" for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="password" type="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                </div>
                <p id="error-message" class="text-red-500 text-center mb-4 hidden"></p>
                <button type="submit" id="login-button" class="w-full bg-rose-500 text-white py-2 rounded-lg hover:bg-rose-600 transition-colors disabled:bg-rose-300">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
        </div>
    </div>

    <!-- Diary Section -->
    <div id="diary-section" class="hidden min-h-screen p-4 sm:p-8">
        <div class="max-w-3xl mx-auto">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-rose-500">Sweet Times</h1>
                    <p class="text-gray-500">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏ß‡∏µ‡∏ó‡∏Ç‡∏≠‡∏á‡∏™‡∏≠‡∏á‡πÄ‡∏£‡∏≤</p>
                </div>
                <button id="logout-button" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </header>

            <!-- New Date Form -->
            <div id="new-date-form-container" class="bg-white p-6 rounded-2xl shadow-md mb-8 hidden">
                 <h2 class="text-2xl font-bold text-rose-500 mb-4 text-center">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                 <form id="new-date-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Ñ‡∏ô‡∏ä‡∏ß‡∏ô)</label>
                        <select id="creator-name" class="w-full px-4 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-rose-400" required>
                            <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì --</option>
                            <option value="Pui">Pui</option>
                            <option value="Noon">Noon</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                        <input id="title" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏õ‡πÄ‡∏î‡∏ó‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏Å‡∏±‡∏ô! ‚ú®" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ</label>
                        <textarea id="description" placeholder="‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞ üòä" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input id="event-datetime" type="datetime-local" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                    </div>
                    <div class="flex items-center justify-end pt-2 space-x-4">
                         <button type="button" id="cancel-new-date" class="text-gray-600 hover:text-rose-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                         <button type="submit" id="save-date-button" class="bg-rose-500 text-white px-6 py-2 rounded-lg hover:bg-rose-600 transition-colors">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç</button>
                    </div>
                 </form>
            </div>
            
            <div class="text-center mb-8">
                <button id="show-form-button" class="bg-rose-500 text-white px-8 py-3 rounded-full text-lg shadow-md hover:bg-rose-600 transition-all transform hover:scale-105 inline-block">
                    + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>

            <!-- Dates List -->
            <div id="dates-list" class="space-y-4"></div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // =================================================================
        //  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è  1. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // =================================================================
        const SUPABASE_URL = 'https://fmbympgecspgqtnazrbm.supabase.co'; // <<<< ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtYnltcGdlY3NwZ3F0bmF6cmJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDkwOTksImV4cCI6MjA2NjMyNTA5OX0.rqOrNDNRTF7WnDS6utTTKfFoNZKPiMZV_ttqYzYCaJs'; // <<<< ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        // =================================================================

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const diarySection = document.getElementById('diary-section');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const logoutButton = document.getElementById('logout-button');
        const datesList = document.getElementById('dates-list');
        const showFormButton = document.getElementById('show-form-button');
        const newDateFormContainer = document.getElementById('new-date-form-container');
        const newDateForm = document.getElementById('new-date-form');
        const cancelNewDateButton = document.getElementById('cancel-new-date');
        
        let currentUser = null;

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric', month: 'long', day: 'numeric'
            }) + ' ‡πÄ‡∏ß‡∏•‡∏≤ ' + date.toLocaleTimeString('th-TH', {
                hour: '2-digit', minute: '2-digit', hour12: false
            }) + ' ‡∏ô.';
        };
        
        const getStatusBadge = (status) => {
            switch(status) {
                case 'accepted': return '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-1 rounded-full">‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>';
                case 'declined': return '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-1 rounded-full">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>';
                default: return '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-1 rounded-full">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</span>';
            }
        };

        const fetchAndRenderDates = async () => {
            if (!currentUser) return;
            datesList.innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥... üíñ</p>';
            
            const { data, error } = await db
                .from('sweet_dates')
                .select('*')
                .or(`creator_id.eq.${currentUser.id},invitee_id.eq.${currentUser.id}`)
                .order('event_datetime', { ascending: false });

            if (error) {
                console.error('Error fetching dates:', error);
                datesList.innerHTML = `<p class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</p>`;
                return;
            }

            if (data.length === 0) {
                datesList.innerHTML = '<p class="text-center text-gray-500 bg-white p-6 rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!</p>';
                return;
            }
            
            datesList.innerHTML = '';
            data.forEach(date => {
                const isCreator = date.creator_id === currentUser.id;
                const isInvitee = date.invitee_id === currentUser.id;
                
                let actionButtons = '';
                if (isInvitee && date.status === 'pending') {
                    actionButtons = `
                        <div class="mt-4 flex space-x-2">
                            <button onclick="handleResponse(${date.id}, true)" class="bg-green-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-green-600">‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</button>
                            <button onclick="handleResponse(${date.id}, false)" class="bg-red-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-red-600">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                        </div>`;
                }
                
                if (isCreator) {
                    //  ‚úÖ  ‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ SVG ‡πÅ‡∏ó‡∏ô
                    actionButtons += `<button onclick="deleteDate(${date.id})" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-1 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M3 6h18"></path>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                      </button>`;
                }

                const dateCard = `
                    <div class="relative bg-white p-6 rounded-2xl shadow-md border-l-4 ${date.status === 'accepted' ? 'border-green-400' : date.status === 'declined' ? 'border-red-400' : 'border-yellow-400'} animate-fade-in">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400">${formatDate(date.event_datetime)}</p>
                                <h2 class="text-2xl font-bold text-gray-800 mt-1">${date.title}</h2>
                                <p class="text-sm text-gray-500 mt-1">‡∏ä‡∏ß‡∏ô‡πÇ‡∏î‡∏¢: ${date.creator_name}</p>
                            </div>
                            <div>${getStatusBadge(date.status)}</div>
                        </div>
                        <p class="text-gray-600 mt-2">${date.description || ''}</p>
                        ${date.status === 'declined' && date.response_reason ? `<p class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded-md">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${date.response_reason}</p>` : ''}
                        ${actionButtons}
                    </div>`;
                datesList.innerHTML += dateCard;
            });
        };

        window.handleResponse = async (dateId, accepted) => {
            let updateData = { status: accepted ? 'accepted' : 'declined' };
            if (!accepted) {
                const reason = prompt("‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:", "");
                if (reason !== null) { updateData.response_reason = reason; }
            }
            const { error } = await db.from('sweet_dates').update(updateData).match({ id: dateId });
            if (error) alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            else fetchAndRenderDates();
        };

        window.deleteDate = async (dateId) => {
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ?")) {
                const { error } = await db.from('sweet_dates').delete().match({ id: dateId });
                if (error) alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                else fetchAndRenderDates();
            }
        };
        
        const showDiaryPage = async () => {
            const { data } = await db.auth.getUser();
            currentUser = data.user;
            if (currentUser) {
                loginSection.classList.add('hidden');
                diarySection.classList.remove('hidden');
                fetchAndRenderDates();
            } else {
                showLoginPage();
            }
        };

        const showLoginPage = () => {
            currentUser = null;
            loginSection.classList.remove('hidden');
            diarySection.classList.add('hidden');
        };

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('login-button');
            
            loginButton.disabled = true;
            loginButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            errorMessage.classList.add('hidden');

            const { data, error } = await db.auth.signInWithPassword({ email, password });

            if (error) {
                console.error("Login Error:", error);
                errorMessage.textContent = `Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
                errorMessage.classList.remove('hidden');
                loginButton.disabled = false;
                loginButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            } else if (data.session) {
                showDiaryPage();
            } else {
                errorMessage.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                errorMessage.classList.remove('hidden');
                loginButton.disabled = false;
                loginButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            await db.auth.signOut();
            showLoginPage();
        });
        
        showFormButton.addEventListener('click', () => {
            newDateFormContainer.classList.remove('hidden');
            showFormButton.classList.add('hidden');
        });
        
        cancelNewDateButton.addEventListener('click', () => {
            newDateFormContainer.classList.add('hidden');
            showFormButton.classList.remove('hidden');
            newDateForm.reset();
        });
        
        newDateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà'); return; }

            const saveButton = document.getElementById('save-date-button');
            saveButton.disabled = true;
            saveButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

            // =================================================================
            //  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è  2. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà USER ID ‡∏Ç‡∏≠‡∏á Pui ‡πÅ‡∏•‡∏∞ Noon ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
            // =================================================================
            const USER_IDS = {
                Pui: '6c2d9e89-f6dc-4ce1-abb5-ff3747e5066a',    // <<<< ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                Noon: '74527e79-eb4d-4541-9aad-956dd72bb601'   // <<<< ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            };
            // =================================================================

            const creatorName = document.getElementById('creator-name').value;
            if (!creatorName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ä‡∏ß‡∏ô');
                saveButton.disabled = false;
                saveButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç';
                return;
            }

            const inviteeName = creatorName === 'Pui' ? 'Noon' : 'Pui';
            const inviteeId = USER_IDS[inviteeName];

            if (!inviteeId || inviteeId.includes('YOUR')) {
                 alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ User ID ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î JavaScript ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!');
                 saveButton.disabled = false;
                 saveButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç';
                 return;
            }
            
            const newDate = {
                creator_id: currentUser.id,
                creator_name: creatorName,
                invitee_id: inviteeId,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                event_datetime: document.getElementById('event-datetime').value,
                status: 'pending'
            };

            const { error } = await db.from('sweet_dates').insert([newDate]);
            if (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                console.error("Insert Error:", error);
            } else {
                newDateForm.reset();
                newDateFormContainer.classList.add('hidden');
                showFormButton.classList.remove('hidden');
                await fetchAndRenderDates();
            }
            saveButton.disabled = false;
            saveButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç';
        });
        
        const checkSession = async () => {
            if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_SUPABASE_URL')) {
                document.body.innerHTML = '<div class="text-red-600 text-2xl text-center p-10">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</div>';
                return;
            }
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                showDiaryPage();
            } else {
                showLoginPage();
            }
        };

        checkSession();
    </script>
</body>
</html>
