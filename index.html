<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Times üíñ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Itim', cursive; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-rose-50">

    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold text-rose-500 mb-2">Sweet Times</h1>
            <p class="text-gray-500 mb-6">üíñ PUI & NOON üíñ</p>
            <form id="login-form">
                <div class="mb-4 text-left">
                    <label class="block text-gray-700 mb-1" for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input id="email" type="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                </div>
                <div class="mb-6 text-left">
                    <label class="block text-gray-700 mb-1" for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="password" type="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                </div>
                <p id="error-message" class="text-red-500 text-center mb-4 hidden"></p>
                <button type="submit" id="login-button" class="w-full bg-rose-500 text-white py-2 rounded-lg hover:bg-rose-600 transition-colors disabled:bg-rose-300">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
        </div>
    </div>

    <!-- Diary Section -->
    <div id="diary-section" class="hidden min-h-screen p-4 sm:p-8">
        <div class="max-w-3xl mx-auto">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-rose-500">Sweet Times</h1>
                    <p class="text-gray-500">PUI & NOON</p>
                </div>
                <button id="logout-button" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </header>

            <div class="mb-6">
                <button id="show-form-button" class="w-full bg-rose-500 text-white px-8 py-3 rounded-lg text-lg shadow-md hover:bg-rose-600 transition-all transform hover:scale-105 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</span>
                </button>
            </div>

            <div id="new-date-form-container" class="bg-white p-6 rounded-2xl shadow-md mb-8 hidden">
                <h2 id="form-title" class="text-2xl font-bold text-rose-500 mb-4 text-center">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                <form id="new-date-form" class="space-y-4">
                   <input type="hidden" id="editing-date-id">
                   <div>
                       <label class="block text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Ñ‡∏ô‡∏ä‡∏ß‡∏ô)</label>
                       <select id="creator-name" class="w-full px-4 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-rose-400 disabled:bg-gray-100 disabled:cursor-not-allowed" required>
                           <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì --</option>
                           <option value="Pui">Pui</option>
                           <option value="Noon">Noon</option>
                       </select>
                   </div>
                   <div>
                       <label class="block text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                       <input id="title" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏õ‡πÄ‡∏î‡∏ó‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏Å‡∏±‡∏ô! ‚ú®" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                   </div>
                   <div>
                       <label class="block text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ</label>
                       <textarea id="description" placeholder="‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞ üòä" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400"></textarea>
                   </div>
                   <div>
                       <label class="block text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                       <input id="event-datetime" type="datetime-local" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400" required />
                   </div>
                   <div class="flex items-center justify-end pt-2 space-x-4">
                        <button type="button" id="cancel-new-date" class="text-gray-600 hover:text-rose-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" id="save-date-button" class="bg-rose-500 text-white px-6 py-2 rounded-lg hover:bg-rose-600 transition-colors">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç</button>
                   </div>
                </form>
            </div>
            
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-pending" onclick="changeTab('pending')" class="tab-button flex items-center whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        <span>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</span>
                        <span id="count-pending" class="ml-2 bg-yellow-200 text-yellow-800 text-xs font-semibold px-2 py-0.5 rounded-full hidden">0</span>
                    </button>
                    <button id="tab-upcoming" onclick="changeTab('upcoming')" class="tab-button flex items-center whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        <span>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á</span>
                        <span id="count-upcoming" class="ml-2 bg-rose-200 text-rose-800 text-xs font-semibold px-2 py-0.5 rounded-full hidden">0</span>
                    </button>
                    <button id="tab-past" onclick="changeTab('past')" class="tab-button flex items-center whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥</span>
                        <span id="count-past" class="ml-2 bg-gray-200 text-gray-800 text-xs font-semibold px-2 py-0.5 rounded-full hidden">0</span>
                    </button>
                </nav>
            </div>

            <div id="dates-list" class="space-y-4"></div>

            <div id="pagination-controls" class="mt-8 flex justify-between items-center hidden">
                <button id="prev-button" onclick="changePage(-1)" class="bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                </button>
                <span id="page-info" class="text-sm text-gray-600"></span>
                <button id="next-button" onclick="changePage(1)" class="bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        //  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL, KEY, ‡πÅ‡∏•‡∏∞ USER IDs ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // =================================================================
        const SUPABASE_URL = 'https://fmbympgecspgqtnazrbm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtYnltcGdlY3NwZ3F0bmF6cmJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDkwOTksImV4cCI6MjA2NjMyNTA5OX0.rqOrNDNRTF7WnDS6utTTKfFoNZKPiMZV_ttqYzYCaJs';
        const USER_IDS = {
            Pui: '6c2d9e89-f6dc-4ce1-abb5-ff3747e5066a',
            Noon: '74527e79-eb4d-4541-9aad-956dd72bb601'
        };
        // =================================================================
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginSection = document.getElementById('login-section');
        const diarySection = document.getElementById('diary-section');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const logoutButton = document.getElementById('logout-button');
        const datesList = document.getElementById('dates-list');
        const showFormButton = document.getElementById('show-form-button');
        const newDateFormContainer = document.getElementById('new-date-form-container');
        const newDateForm = document.getElementById('new-date-form');
        const cancelNewDateButton = document.getElementById('cancel-new-date');
        
        let currentUser = null;
        let activeTab = 'upcoming';
        let currentPage = 0;
        const PAGE_SIZE = 5;

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) + ' ‡πÄ‡∏ß‡∏•‡∏≤ ' + date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false }) + ' ‡∏ô.';
        };
        
        const getStatusBadge = (status) => {
            switch(status) {
                case 'accepted': return '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-1 rounded-full">‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>';
                case 'declined': return '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-1 rounded-full">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>';
                default: return '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-1 rounded-full">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</span>';
            }
        };

        const getResponseNoteHTML = (date) => {
            if (!date.response_note) return '';
            if (date.status === 'accepted') { return `<p class="mt-2 text-sm text-green-700 bg-green-50 p-2 rounded-md">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: ${date.response_note}</p>`; }
            if (date.status === 'declined') { return `<p class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded-md">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${date.response_note}</p>`; }
            return '';
        };
        
        const updateTabCounts = async () => {
            if (!currentUser) return;
            const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
            try {
                const [pendingResult, upcomingResult, pastResult] = await Promise.all([
                    db.from('sweet_dates').select('id', { count: 'exact', head: true }).eq('status', 'pending'),
                    db.from('sweet_dates').select('id', { count: 'exact', head: true }).eq('status', 'accepted').gte('event_datetime', now),
                    db.from('sweet_dates').select('id', { count: 'exact', head: true }).lt('event_datetime', now).in('status', ['accepted', 'declined'])
                ]);
                const counts = { pending: pendingResult.count || 0, upcoming: upcomingResult.count || 0, past: pastResult.count || 0 };
                for (const key in counts) {
                    const countBadge = document.getElementById(`count-${key}`);
                    if (counts[key] > 0) {
                        countBadge.textContent = counts[key];
                        countBadge.classList.remove('hidden');
                    } else {
                        countBadge.classList.add('hidden');
                    }
                }
            } catch (error) { console.error("Error fetching tab counts:", error); }
        };

        const renderTabs = () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-rose-500', 'text-rose-600');
                button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            const currentTabButton = document.getElementById(`tab-${activeTab}`);
            currentTabButton.classList.add('border-rose-500', 'text-rose-600');
            currentTabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        };

        const renderPagination = (totalItems) => {
            const paginationControls = document.getElementById('pagination-controls');
            if (!totalItems || totalItems <= PAGE_SIZE) {
                paginationControls.classList.add('hidden');
                return;
            }
            paginationControls.classList.remove('hidden');
            const pageInfo = document.getElementById('page-info');
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage + 1} / ${totalPages}`;
            document.getElementById('prev-button').disabled = (currentPage === 0);
            document.getElementById('next-button').disabled = (currentPage + 1 >= totalPages);
        };

        const fetchAndRenderDates = async () => {
            if (!currentUser) return;
            datesList.innerHTML = '<p class="text-center text-gray-500 p-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... üíñ</p>';
            renderTabs();
            document.getElementById('pagination-controls').classList.add('hidden');
            let query = db.from('sweet_dates').select('*', { count: 'exact' });
            const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
            if (activeTab === 'pending') { query = query.eq('status', 'pending'); }
            else if (activeTab === 'upcoming') { query = query.eq('status', 'accepted').gte('event_datetime', now); }
            else if (activeTab === 'past') { query = query.lt('event_datetime', now).in('status', ['accepted', 'declined']); }
            query = query.order('event_datetime', { ascending: activeTab !== 'past' }).range(currentPage * PAGE_SIZE, (currentPage + 1) * PAGE_SIZE - 1);
            const { data, error, count } = await query;
            if (error) { console.error('Error fetching dates:', error); datesList.innerHTML = `<p class="text-center text-red-500 bg-white p-6 rounded-xl">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`; return; }
            renderPagination(count || 0);
            if (!data || data.length === 0) { datesList.innerHTML = '<p class="text-center text-gray-500 bg-white p-6 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>'; return; }
            datesList.innerHTML = '';
            data.forEach(date => {
                const isCreator = date.creator_id === currentUser.id;
                const isInvitee = date.invitee_id === currentUser.id;
                let responseButtons = '';
                if (isInvitee && date.status === 'pending') { responseButtons = `<div class="flex space-x-2"><button onclick="handleResponse(${date.id}, true)" class="bg-green-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-green-600">‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</button><button onclick="handleResponse(${date.id}, false)" class="bg-red-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-red-600">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button></div>`; }
                
                let actionButtons = '';
                if (isCreator && (activeTab === 'pending' || activeTab === 'upcoming')) { actionButtons += `<button onclick='handleEdit(${JSON.stringify(date)})' class="p-1 text-gray-400 hover:text-blue-500" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>`; }
                if (isCreator) { actionButtons += `<button onclick="deleteDate(${date.id})" class="p-1 text-gray-400 hover:text-red-500" title="‡∏•‡∏ö"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>`; }

                // --- ‚ú® ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ---
                let shareSection = '';
                if (isCreator && date.status === 'pending') {
                    shareSection = `
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <button onclick="shareInvitation(${date.id}, '${date.title.replace(/'/g, "\\'")}', '${date.creator_name}')" class="w-full flex items-center justify-center space-x-2 bg-pink-100 text-pink-700 px-4 py-2 rounded-lg hover:bg-pink-200 transition-colors text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                                <span>‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡∏ä‡∏ß‡∏ô‡∏ô‡∏µ‡πâ</span>
                            </button>
                        </div>
                    `;
                }
                // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ---

                const dateCard = `<div class="relative bg-white p-6 rounded-2xl shadow-md border-l-4 ${date.status === 'accepted' ? 'border-green-400' : date.status === 'declined' ? 'border-red-400' : 'border-yellow-400'} animate-fade-in flex flex-col"><div class="absolute top-4 right-4 flex space-x-2">${actionButtons}</div><div class="flex-grow"><p class="text-sm text-gray-400">${formatDate(date.event_datetime)}</p><h2 class="text-2xl font-bold text-gray-800 mt-1">${date.title}</h2><p class="text-sm text-gray-500 mt-1">‡∏ä‡∏ß‡∏ô‡πÇ‡∏î‡∏¢: ${date.creator_name}</p><p class="text-gray-600 mt-2">${date.description || ''}</p>${getResponseNoteHTML(date)}</div><div class="mt-4 flex justify-between items-center"><div>${responseButtons}</div><div>${getStatusBadge(date.status)}</div></div>${shareSection}</div>`;
                datesList.innerHTML += dateCard;
            });
        };

        window.handleEdit = (date) => {
            const form = document.getElementById('new-date-form');
            form.reset();
            document.getElementById('editing-date-id').value = date.id;
            document.getElementById('form-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
            document.getElementById('save-date-button').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.getElementById('creator-name').value = date.creator_name;
            document.getElementById('creator-name').disabled = true;
            document.getElementById('title').value = date.title;
            document.getElementById('description').value = date.description;
            const localDateTime = new Date(new Date(date.event_datetime).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('event-datetime').value = localDateTime;
            newDateFormContainer.classList.remove('hidden');
            showFormButton.classList.add('hidden');
            window.scrollTo(0, 0);
        };
        
        window.changeTab = (tabName) => { activeTab = tabName; currentPage = 0; fetchAndRenderDates(); };
        window.changePage = (direction) => { currentPage += direction; fetchAndRenderDates(); };

        // --- ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå ---
        window.shareInvitation = (dateId, title, creatorName) => {
            const siteURL = window.location.origin + window.location.pathname;
            const invitationURL = `${siteURL}?date_id=${dateId}`;
            const invitationMessage = `üíñ ${creatorName} ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡πÄ‡∏î‡∏ó! üíñ\n\n"${title}"\n\n‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏ô‡∏∞:\n${invitationURL}\n\n‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≤‡∏≤‡∏≤ üòä`;

            if (navigator.share) {
                navigator.share({
                    title: `‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡∏ä‡∏ß‡∏ô‡πÑ‡∏õ‡πÄ‡∏î‡∏ó‡∏à‡∏≤‡∏Å ${creatorName}`,
                    text: invitationMessage,
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(invitationMessage).then(() => {
                    alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏ç‡∏ä‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ü‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üíå');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ');
                });
            }
        };

        window.handleResponse = async (dateId, accepted) => {
            const promptMessage = accepted ? "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏¥:" : "‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:";
            const defaultText = accepted ? "‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏à‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏£‡πä‡∏≤‡∏Å‡∏Å‡∏Å! ü•∞" : "";
            const note = prompt(promptMessage, defaultText);
            if (note === null) { return; }
            let updateData = { status: accepted ? 'accepted' : 'declined', response_note: note };
            const { error } = await db.from('sweet_dates').update(updateData).match({ id: dateId });
            if (error) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); }
            else { await updateTabCounts(); fetchAndRenderDates(); }
        };

        window.deleteDate = async (dateId) => {
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ?")) {
                const { error } = await db.from('sweet_dates').delete().match({ id: dateId });
                if (error) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); }
                else { await updateTabCounts(); fetchAndRenderDates(); }
            }
        };
        
        const showDiaryPage = async () => {
            const { data } = await db.auth.getUser();
            currentUser = data.user;
            if (currentUser) {
                loginSection.classList.add('hidden');
                diarySection.classList.remove('hidden');
                await updateTabCounts();
                changeTab('upcoming');
            } else { showLoginPage(); }
        };

        const showLoginPage = () => {
            currentUser = null;
            loginSection.classList.remove('hidden');
            diarySection.classList.add('hidden');
        };

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            errorMessage.classList.add('hidden');
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) {
                console.error("Login Error:", error);
                errorMessage.textContent = `Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
                errorMessage.classList.remove('hidden');
                loginButton.disabled = false;
                loginButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            } else if (data.session) { showDiaryPage(); }
        });
        
        logoutButton.addEventListener('click', async () => {
            await db.auth.signOut();
            showLoginPage();
        });
        
        showFormButton.addEventListener('click', () => {
            const form = document.getElementById('new-date-form');
            form.reset();
            const loggedInUserName = Object.keys(USER_IDS).find(name => USER_IDS[name] === currentUser.id);
            document.getElementById('editing-date-id').value = '';
            document.getElementById('form-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('save-date-button').textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç';
            const creatorNameSelect = document.getElementById('creator-name');
            if (loggedInUserName) {
                creatorNameSelect.value = loggedInUserName;
                creatorNameSelect.disabled = true;
            } else {
                creatorNameSelect.value = '';
                creatorNameSelect.disabled = false;
            }
            newDateFormContainer.classList.remove('hidden');
            showFormButton.classList.add('hidden');
        });
        
        cancelNewDateButton.addEventListener('click', () => {
            newDateFormContainer.classList.add('hidden');
            showFormButton.classList.remove('hidden');
            newDateForm.reset();
            document.getElementById('creator-name').disabled = false;
        });
        
        newDateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà'); return; }
            const saveButton = document.getElementById('save-date-button');
            saveButton.disabled = true;
            saveButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            const editingId = document.getElementById('editing-date-id').value;
            const isEditing = !!editingId;
            const creatorName = document.getElementById('creator-name').value;
            const dateData = {
                creator_name: creatorName,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                event_datetime: document.getElementById('event-datetime').value,
            };

            if (!isEditing) {
                const inviteeName = creatorName === 'Pui' ? 'Noon' : 'Pui';
                const inviteeId = USER_IDS[inviteeName];
                dateData.creator_id = currentUser.id;
                dateData.invitee_id = inviteeId;
                dateData.status = 'pending';
            }

            let error;
            if (isEditing) {
                const { error: updateError } = await db.from('sweet_dates').update(dateData).match({ id: editingId });
                error = updateError;
            } else {
                const { error: insertError } = await db.from('sweet_dates').insert([dateData]);
                error = insertError;
            }

            if (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                console.error("Submit Error:", error);
            } else {
                newDateForm.reset();
                newDateFormContainer.classList.add('hidden');
                showFormButton.classList.remove('hidden');
                await updateTabCounts();
                changeTab(isEditing ? activeTab : 'pending');
            }
            
            saveButton.disabled = false;
            document.getElementById('editing-date-id').value = '';
            document.getElementById('form-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('creator-name').disabled = false;
            saveButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç';
        });
        
        const checkSession = async () => {
            if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_SUPABASE_URL')) {
                document.body.innerHTML = '<div class="text-red-600 text-2xl text-center p-10">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</div>';
                return;
            }
            const { data: { session } } = await db.auth.getSession();
            if (session) { showDiaryPage(); }
            else { showLoginPage(); }
        };

        checkSession();
    </script>
</body>
</html>
