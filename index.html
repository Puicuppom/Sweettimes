<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Secret Diary üíñ</title>
    
    <!-- 1. ‡∏î‡∏∂‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ ‡∏à‡∏≤‡∏Å Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    
    <!-- 2. ‡∏î‡∏∂‡∏á Tailwind CSS ‡∏ú‡πà‡∏≤‡∏ô CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3. ‡∏î‡∏∂‡∏á Supabase Client ‡∏ú‡πà‡∏≤‡∏ô CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å -->
    <style>
        body {
            font-family: 'Itim', cursive;
        }
    </style>
</head>
<body class="bg-pink-50">

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏´‡∏ô‡πâ‡∏≤ Login (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å) -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
            <h1 class="text-4xl text-center font-bold text-pink-500 mb-2">Our Secret Diary</h1>
            <p class="text-center text-gray-500 mb-6">üíñ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏™‡∏≠‡∏á‡∏Ñ‡∏ô üíñ</p>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-1" for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input id="email" type="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400" required />
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-1" for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="password" type="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400" required />
                </div>
                <p id="error-message" class="text-red-500 text-center mb-4 hidden"></p>
                <button type="submit" id="login-button" class="w-full bg-pink-500 text-white py-2 rounded-lg hover:bg-pink-600 transition-colors disabled:bg-pink-300">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                </button>
            </form>
        </div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏´‡∏ô‡πâ‡∏≤ Diary (‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å) -->
    <div id="diary-section" class="hidden min-h-screen p-4 sm:p-8">
        <div class="max-w-3xl mx-auto">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-pink-500">Our Sweet Diary</h1>
                    <p class="text-gray-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</p>
                </div>
                <button id="logout-button" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </header>

            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ) -->
            <div id="new-date-form-container" class="bg-white p-6 rounded-2xl shadow-md mb-8 hidden">
                 <h2 class="text-2xl font-bold text-pink-500 mb-4 text-center">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                 <form id="new-date-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ä‡∏ß‡∏ô</label>
                        <input id="creator-name" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏•‡∏≠‡∏¢, ‡πÅ‡∏ö‡∏á‡∏Ñ‡πå" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400" required />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                        <input id="title" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏õ‡πÄ‡∏î‡∏ó‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏Å‡∏±‡∏ô! ‚ú®" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400" required />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ</label>
                        <textarea id="description" placeholder="‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞ üòä" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input id="event-datetime" type="datetime-local" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400" required />
                    </div>
                    <div class="flex items-center justify-end pt-2 space-x-4">
                         <button type="button" id="cancel-new-date" class="text-gray-600 hover:text-pink-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                         <button type="submit" id="save-date-button" class="bg-pink-500 text-white px-6 py-2 rounded-lg hover:bg-pink-600 transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                    </div>
                 </form>
            </div>
            
            <div class="text-center mb-8">
                <button id="show-form-button" class="bg-pink-500 text-white px-8 py-3 rounded-full text-lg shadow-md hover:bg-pink-600 transition-all transform hover:scale-105 inline-block">
                    + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
            <div id="dates-list" class="space-y-4">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JavaScript -->
            </div>
        </div>
    </div>


    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡πÇ‡∏Ñ‡πâ‡∏î JavaScript ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
    <script>
        // =================================================================
        //  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ** ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ** ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // =================================================================
        const SUPABASE_URL = 'https://fmbympgecspgqtnazrbm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtYnltcGdlY3NwZ3F0bmF6cmJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDkwOTksImV4cCI6MjA2NjMyNTA5OX0.rqOrNDNRTF7WnDS6utTTKfFoNZKPiMZV_ttqYzYCaJs';
        // =================================================================

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ‡∏î‡∏∂‡∏á Element ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        const loginSection = document.getElementById('login-section');
        const diarySection = document.getElementById('diary-section');
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const logoutButton = document.getElementById('logout-button');
        const datesList = document.getElementById('dates-list');
        const showFormButton = document.getElementById('show-form-button');
        const newDateFormContainer = document.getElementById('new-date-form-container');
        const newDateForm = document.getElementById('new-date-form');
        const cancelNewDateButton = document.getElementById('cancel-new-date');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
        const fetchAndRenderDates = async () => {
            datesList.innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥... üíñ</p>';
            
            const { data, error } = await db
                .from('sweet_dates')
                .select('*')
                .order('event_datetime', { ascending: false });

            if (error) {
                console.error('Error fetching dates:', error);
                datesList.innerHTML = '<p class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            if (data.length === 0) {
                datesList.innerHTML = '<p class="text-center text-gray-500 bg-white p-6 rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!</p>';
                return;
            }

            datesList.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            data.forEach(date => {
                const dateCard = `
                    <div class="bg-white p-6 rounded-2xl shadow-md border-l-4 border-pink-400 animate-fade-in">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400">
                                    ${new Date(date.event_datetime).toLocaleDateString('th-TH', {
                                        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                    })} ‡∏ô.
                                </p>
                                <h2 class="text-2xl font-bold text-gray-800 mt-1">${date.title}</h2>
                            </div>
                            <span class="bg-pink-100 text-pink-700 text-xs font-semibold px-2.5 py-1 rounded-full">
                                ‡∏ä‡∏ß‡∏ô‡πÇ‡∏î‡∏¢: ${date.creator_name}
                            </span>
                        </div>
                        <p class="text-gray-600 mt-2">${date.description || ''}</p>
                    </div>
                `;
                datesList.innerHTML += dateCard;
            });
        };
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        const showDiaryPage = () => {
            loginSection.classList.add('hidden');
            diarySection.classList.remove('hidden');
            fetchAndRenderDates();
        };

        const showLoginPage = () => {
            loginSection.classList.remove('hidden');
            diarySection.classList.add('hidden');
        };

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            loginButton.disabled = true;
            loginButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            errorMessage.classList.add('hidden');

            const { data, error } = await db.auth.signInWithPassword({ email, password });

            if (error) {
                errorMessage.textContent = '‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞';
                errorMessage.classList.remove('hidden');
                loginButton.disabled = false;
                loginButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà';
            } else {
                showDiaryPage();
            }
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ Logout
        logoutButton.addEventListener('click', async () => {
            await db.auth.signOut();
            showLoginPage();
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
        showFormButton.addEventListener('click', () => {
            newDateFormContainer.classList.remove('hidden');
            showFormButton.classList.add('hidden');
        });

        cancelNewDateButton.addEventListener('click', () => {
            newDateFormContainer.classList.add('hidden');
            showFormButton.classList.remove('hidden');
            newDateForm.reset();
        });

        newDateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = (await db.auth.getUser()).data.user;

            if (!user) {
                alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà');
                showLoginPage();
                return;
            }

            const newDate = {
                creator_id: user.id,
                creator_name: document.getElementById('creator-name').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                event_datetime: document.getElementById('event-datetime').value,
            };
            
            const saveButton = document.getElementById('save-date-button');
            saveButton.disabled = true;
            saveButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const { error } = await db.from('sweet_dates').insert([newDate]);

            if (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } else {
                newDateForm.reset();
                newDateFormContainer.classList.add('hidden');
                showFormButton.classList.remove('hidden');
                await fetchAndRenderDates(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            }

            saveButton.disabled = false;
            saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
        });

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        const checkSession = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                showDiaryPage();
            } else {
                showLoginPage();
            }
        };

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        checkSession();

    </script>
</body>
</html>